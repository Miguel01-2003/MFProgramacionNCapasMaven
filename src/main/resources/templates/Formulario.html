<!DOCTYPE html>

<html>
    <head>
        <title>Formulario</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
        
        <style>
            body {
                background-color: #143642;
            }
            div{
                background-color: #DAD2D8;
                border-radius: 20px;
            }
            #contenedor{
                padding: 3%;
            }
        </style>
    </head>
    <body class="container">
    <br>
    <div class="row">
        <h1 class="display-1">Registro de usuario</h1>
        <p class="lead">Completa el formulario para agregar un nuevo usuario</p>
    </div>
    <br>
    
    <br>
    <form method="post" th:object="${usuario}" th:action="@{/usuario/form}" enctype="multipart/form-data">
        <div id="contenedor">
            <h4><i class="bi bi-people-fill"></i>Datos personales</h4><br>
            <div class="row">
                <div class="col">              
                    <img id="FotoUsuario" style="max-width: 250px" src="https://static.vecteezy.com/system/resources/previews/008/442/086/original/illustration-of-human-icon-user-symbol-icon-modern-design-on-blank-background-free-vector.jpg" class="img-thumbnail"> 
                </div>   
                <div class="col">
                    <label for="FotoUsuario" class="form-label fw-bold">Foto del usuario</label>
                    <input type="file" class="form-control mb-2" name="imagenFile" id="imagenFile" accept="image/*" onchange="ValidacionImagen(event)">
                </div>   
                
            </div>

            <br>
            
            <div class="row">
                <div class="col">
                    <label for="Nombre" class="form-label fw-bold">Nombre</label>
                    <input id="Nombre" type="text" class="form-control" placeholder="Nombre" th:field="*{Nombre}" onkeypress="ValidarNombre(this, event)" onblur="ValidarNombreBlur(this)">
                    <span id="errorNombre" style="color: red"></span>
                    <span class="text-danger" th:if="${#fields.hasErrors('Nombre')}" th:errors="*{Nombre}"></span>
                </div>
                <div class="col">
                    <label for="ApellidoPaterno" class="form-label fw-bold">Apellido Paterno</label>
                    <input id="ApellidoPaterno" type="text" class="form-control" placeholder="Apellido Paterno" th:field="*{ApellidoPaterno}" onkeypress="SoloLetras(this, event)" onblur="SoloLetrasBlur(this)">
                    <span id="errorApellidoPaterno" style="color: red"></span>
                    <span class="text-danger" th:if="${#fields.hasErrors('ApellidoPaterno')}" th:errors="*{ApellidoPaterno}"></span>
                </div>
                <div class="col">
                    <label for="ApellidoMaterno" class="form-label fw-bold">Apellido Materno</label>
                    <input id="ApellidoMaterno" type="text" class="form-control" placeholder="Apellido Paterno" th:field="*{ApellidoMaterno}" onkeypress="SoloLetras(this, event)" onblur="SoloLetrasBlur(this)">
                    <span id="errorApellidoMaterno" style="color: red"></span>
                    <span class="text-danger" th:if="${#fields.hasErrors('ApellidoMaterno')}" th:errors="*{ApellidoMaterno}"></span>
                </div>
            </div>
            <br>
            <div class="row">
                <div class="col">  
                    <label for="Sexo" class="form-label fw-bold">Sexo</label><br>       
                    <input type="radio" id="Hombre" name="Sexo" value="MA" th:field="*{Sexo}">
                    <label for="Hombre">Hombre</label><br>
                    <input type="radio" id="Mujer" name="Sexo" value="FE" th:field="*{Sexo}">
                    <label for="Mujer">Mujer</label><br>
                    <span class="text-danger" th:if="${#fields.hasErrors('Sexo')}" th:errors="*{Sexo}"></span>
                </div>
                <div class="col">
                    <label for="CURP" class="form-label fw-bold">CURP</label>
                    <input id="CURP" type="text" class="form-control" placeholder="CURP" th:field="*{CURP}" onkeypress="ValidarCurp(this, event)" onblur="ValidarCurpBlur(this)">
                    <span id="errorCURP" style="color: red"></span>
                    <span class="text-danger" th:if="${#fields.hasErrors('CURP')}" th:errors="*{CURP}"></span>
                </div>
                <div class="col">
                    <label for="FechaNacimiento" class="form-label fw-bold">Fecha de Nacimiento</label>
                    <input id="FechaNacimiento" type="date" class="form-control" th:field="*{FechaNacimiento}" onkeypress="ValidarFechaNacimiento(this, event)" onblur="ValidarFechaNacimiento(this, event)">
                    <span id="errorFechaNacimiento" style="color: red"></span>
                    <span class="text-danger" th:if="${#fields.hasErrors('FechaNacimiento')}" th:errors="*{FechaNacimiento}"></span>
                </div>
            </div>
        </div>
    
        <br><br>
        
        <div id="contenedor">
            <h4><i class="bi bi-shield-lock-fill"></i>Acceso y contacto</h4><br>
            <div class="row">
                <div class="col">
                    <label for="UserName" class="form-label fw-bold">Username</label>
                    <input id="UserName" type="text" class="form-control" placeholder="Username" th:field="*{UserName}">
                    <span id="errorUserName" style="color: red"></span>
                </div>
                <div class="col">
                    <label for="Email" class="form-label fw-bold">Email</label>
                    <input id="Email" type="email" class="form-control" placeholder="Email" th:field="*{Email}">
                    <span id="errorEmail" style="color: red"></span>
                    <span class="text-danger" th:if="${#fields.hasErrors('Email')}" th:errors="*{Email}"></span>
                </div>
                <div class="col">
                    <label for="Password" class="form-label fw-bold">Password</label>
                    <input id="Password" type="password" class="form-control" placeholder="Password" th:field="*{Password}">
                    <span id="errorPassword" style="color: red"></span>
                    <span class="text-danger" th:if="${#fields.hasErrors('Password')}" th:errors="*{Password}"></span>
                </div>
            </div>
            <br>
            <div class="row">
                <div class="col">
                    <label for="Telefono" class="form-label fw-bold">Telefono (10 Digitos)</label>
                    <input id="Telefono" type="text" class="form-control" placeholder="Telefono" th:field="*{Telefono}">
                    <span id="errorTelefono" style="color: red"></span>
                    <span class="text-danger" th:if="${#fields.hasErrors('Telefono')}" th:errors="*{Telefono}"></span>
                </div>
                <div class="col">
                    <label for="Celular" class="form-label fw-bold">Celular (10 Digitos)</label>
                    <input id="Celular" type="text" class="form-control" placeholder="Celular" th:field="*{Celular}">
                    <span id="errorCelular" style="color: red"></span>
                    <span class="text-danger" th:if="${#fields.hasErrors('Celular')}" th:errors="*{Celular}"></span>
                </div>
                <div class="col">
                    <label for="Rol" class="form-label fw-bold">Rol</label><br>
                    <select id="Rol" class="form-select" aria-label="Default select example" th:field="*{Rol.IdRol}">
                        <option value="0" selected >Seleccione un rol...</option>
                        <option th:each="Rol :${roles}" th:value="${Rol.IdRol}" th:text="${Rol.Nombre}"></option>
                    </select>
                    <span id="errorRol" style="color: red"></span>
                    <span class="text-danger" th:if="${#fields.hasErrors('Rol')}" th:errors="*{Rol.IdRol}"></span>
                </div>
            </div>
        </div>
    
        <br><br>
        
        <div id="contenedor">
            <h4><i class="bi bi-house-fill"></i>Direccion</h4><br>
            <div class="row">   
                <div class="col">
                    <label for="paisddl" class="form-label fw-bold">Pais</label><br>
                    <select id="ddlpais" class="form-select" aria-label="Default select example" th:field="*{Direcciones[0].Colonia.Municipio.Estado.Pais.IdPais}">
                        <option value="0" selected>Selecciona un pais...</option>
                        <option th:each="pais : ${paises}" th:value="${pais.IdPais}" th:text="${pais.Nombre}"></option>
                    </select>
                    <span id="errorddlpais" style="color: red"></span>
                </div>
                <div class="col">
                    <label for="estadoddl" class="form-label fw-bold">Estado</label><br>
                    <select id="ddlestado" class="form-select" aria-label="Default select example" th:field="*{Direcciones[0].Colonia.Municipio.Estado.IdEstado}">
                        <option value="0" selected>Seleccione un pais primero...</option>
                        <option th:each="estado: ${estados}" th:value="${estado.IdEstado}" th:text="${estado.Nombre}"></option>
                    </select>
                    <span id="errorddlestado" style="color: red"></span>
                </div>
                <div class="col">
                    <label for="Municipio" class="form-label fw-bold">Municipio</label>
                    <select id="ddlmunicipio" class="form-select" aria-label="Default select example" th:field="*{Direcciones[0].Colonia.Municipio.IdMunicipio}">
                        <option value="0" selected>Seleccione un estado primero...</option>
                        <option th:each="municipio: ${municipios}" th:value="${municipio.IdMunicipio}" th:text="${municipio.Nombre}"></option>
                    </select>
                    <span id="errorddlmunicipio" style="color: red"></span>
                </div>
            </div>
            <br>
            <div class="row">
                <div class="col">
                    <label for="Colonia" class="form-label fw-bold">Colonia</label>
                    <select id="ddlcolonia" class="form-select" aria-label="Default select example" th:field="*{Direcciones[0].Colonia.IdColonia}">
                        <option value="0" selected>Seleccione un municipio primero...</option>
                        <option th:each="colonia : ${colonias}" th:value="${colonia.IdColonia}" th:text="${colonia.Nombre}"></option>
                    </select>
                    <span id="errorddlcolonia" style="color: red"></span>
                </div>
                <div class="col">
                    <label for="CodigoPostal" class="form-label fw-bold">Codigo Postal</label>
                    <input id="CodigoPostal" type="text" class="form-control" placeholder="Codigo Postal" th:field="*{Direcciones[0].colonia.CodigoPostal}">
                    <span id="errorCodigoPostal" style="color: red"></span>
                </div>
                <div class="col">
                    <label for="Calle" class="form-label fw-bold">Calle</label>
                    <input id="Calle" type="text" class="form-control" placeholder="Calle" th:field="*{Direcciones[0].Calle}">
                    <span id="errorCalle" style="color: red"></span>
                </div>
            </div>
            <br>
            <div class="row">
                <div class="col">
                    <label for="NumeroInterior" class="form-label fw-bold">Numero Interior (Opcional)</label>
                    <input id="NumeroInterior" type="text" class="form-control" placeholder="Numero Interior" th:field="*{Direcciones[0].NumeroInterior}">
                    <span id="errorNumeroInterior" style="color: red"></span>
                </div>
                <div class="col">
                    <label for="NumeroExterior" class="form-label fw-bold">Numero Exterior</label>
                    <input id="NumeroExterior" type="text" class="form-control" placeholder="Numero Exterior" th:field="*{Direcciones[0].NumeroExterior}">
                    <span id="errorNumeroExterior" style="color: red"></span>
                </div>
                <div class="col"></div>
            </div>
        </div> 
    
        <br><br>
        
        <div id="contenedor">
            <div class="row">
                <button type="submit" class="btn btn-outline-success">
                    <i class="bi bi-person-fill-add">Guardar Usuario</i>
                </button>
            </div>
        </div> 
    </form> 
</body>
    
    
    <script>
        $(document).ready(function (){
            //Detecta cuando se termino de cargar la pagina
            console.log("Pagina cargada");
            
            
            
            
            $("#ddlpais").change(function() {
                //Detecta un cambio en la DDl de pais
                console.log("Cambio en el DDL de pais");
                
                var IdPais = $("#ddlpais").val();
                
                if(IdPais != 0){
                    $.ajax({
                        url: "/usuario/getEstadosByPais/"+IdPais,
                        type: "GET",
                        dataType: 'json',
                        success: function (data, textStatus, jqXHR) {
                            
                            console.log("Seleccion correcta");
                            
                            $("#ddlestado").empty();
                            $("#ddlestado").append("<option value=0 selected>Seleccione un estado...</option>");
                            $.each(data.objects, function (i,estado){
                                $("#ddlestado").append("<option value="+ estado.IdEstado+">"+estado.Nombre+"</option>");
                            });
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            
                            alert("No se pudo realizar la tarea (Pais)");
                            
                        }
                    });
                    
                    
                    
                }else{
                    $("#ddlestado").empty();
                    $("#ddlestado").append("<option value=0 selected>Seleccione un pais primero...</option>");
                    
                    $("#ddlmunicipio").empty();
                    $("#ddlmunicipio").append("<option value=0 selected>Seleccione un estado primero...</option>");
                        
                    $("#ddlcolonia").empty();
                    $("#ddlcolonia").append("<option value=0 selected>Seleccione un municipio primero...</option>");
                    
                    $("#CodigoPostal").val("");
                }
                
                
                
            });
            
            $("#ddlestado").change(function (){
                var IdPais = $("#ddlpais").val();
                var IdEstado = $("#ddlestado").val();
                    if(IdEstado != 0){
                        $.ajax({
                            url:"/usuario/getEstadosByPais/"+IdPais+"/"+IdEstado,
                            type: "GET",
                            dataType: 'json',
                            success: function (data, textStatus, jqXHR) {
                                
                                console.log("Seleccion de estado correcta");
                                $("#ddlmunicipio").empty();
                                $("#ddlmunicipio").append("<option value=0 selected>Seleccione un municipio...</option>");
                                $.each(data.objects, function (i, municipio){
                                     $("#ddlmunicipio").append("<option value="+municipio.IdMunicipio+">"+municipio.Nombre+"</option>");
                                });
                            },
                            error: function (jqXHR, textStatus, errorThrown) {
                                    
                                alert("No se pudo realizar la tarea (Estado)");    
                            }
                        });
                        
                        
                    }else{
                        $("#ddlmunicipio").empty();
                        $("#ddlmunicipio").append("<option value=0 selected>Seleccione un estado primero...</option>");
                        
                        $("#ddlcolonia").empty();
                        $("#ddlcolonia").append("<option value=0 selected>Seleccione un municipio primero...</option>");
                        
                        $("#CodigoPostal").val("");
                        
                    }
            });
            
            
            $("#ddlmunicipio").change(function (){
                var IdPais = $("#ddlpais").val();
                var IdEstado = $("#ddlestado").val();
                var IdMunicipio = $("#ddlmunicipio").val();
                
                
                if(IdMunicipio != 0){
                    
                    $.ajax({
                        url:"/usuario/getEstadosByPais/"+IdPais+"/"+IdEstado+"/"+IdMunicipio,
                        type: "GET",
                        dataType: 'json',
                        success: function (data, textStatus, jqXHR) {
                            
                            console.log("Seleccion de municipio correcta");
                            $("#ddlcolonia").empty();
                            $("#ddlcolonia").append("<option value=0 selected>Seleccione una colonia...</option>");
                            $.each(data.objects, function (i, colonia){
                                $("#ddlcolonia").append("<option value="+colonia.IdColonia+"  data-cp="+colonia.CodigoPostal+">"+colonia.Nombre+"</option>");
                                
                            });
                            
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                        
                            alert("No se pudo realizar la tarea (Municipio)");    
                        }
                    });
                    
                    
                }else{
                    $("#ddlcolonia").empty();
                    $("#ddlcolonia").append("<option value=0 selected>Seleccione un municipio primero...</option>");
                    
                    $("#CodigoPostal").val("");
                }
            });
            
            $("#ddlcolonia").change(function (){
                var IdPais = $("#ddlpais").val();
                var IdEstado = $("#ddlestado").val();
                var IdMunicipio = $("#ddlmunicipio").val();
                var IdColonia = $("#ddlcolonia").val();
                
                if(IdColonia != 0){
                    
                    var CodigoPostal = $("#ddlcolonia").find(':selected').data('cp');
                    $("#CodigoPostal").val(CodigoPostal);
                    
                }else{
                    $("#CodigoPostal").val("");
                } 
                
            });
            
            
        });
        
        function ValidarNombre(input, event){
            var valorCompleto = $(input).val() + event.key;
                
                var RegEx = /^[a-zA-Z ]+$/;
                
                if(RegEx.test(valorCompleto)){
                    console.log("Se registro con exito");
                    $('#error'+input.id+'').text('');
                    $(input).removeClass('border border-danger');
                }else{
                    console.log("Error con el valor");
                    event.preventDefault();
                    $(input).addClass('border border-danger');
                    $('#error'+input.id+'').text('Solo letras').css('color','red');
                };
        }
        
        function ValidarNombreBlur(input){
            var valorCompleto = $(input).val() + event.key;     
                var RegEx = /^[a-zA-Z ]+( [a-zA-Z]+)?$/;
                
                if(RegEx.test(valorCompleto)){
                    console.log("Se registro con exito");
                    $('#error'+input.id+'').text('');
                    $(input).removeClass('border border-danger');
                    $(input).addClass('border border-success');
                }
        }
        
        function SoloLetras(input,event){
                var valorCompleto = $(input).val() + event.key;
                
                var RegEx = /^[a-zA-Z]+$/;
                
                if(RegEx.test(valorCompleto)){
                    console.log("Se registro con exito");
                    $('#error'+input.id+'').text('');
                    $(input).removeClass('border border-danger');
                }else{
                    console.log("Error con el valor");
                    event.preventDefault();
                    $(input).addClass('border border-danger');
                    $('#error'+input.id+'').text('Solo letras').css('color','red');
                };
                
        };
        
        function SoloLetrasBlur(input){
            var valorCompleto = $(input).val() + event.key; 
            var RegEx = /^[a-zA-Z]+$/;
            
            if(RegEx.test(valorCompleto)){
                    console.log("Se registro con exito");
                    $('#error'+input.id+'').text('');
                    $(input).removeClass('border border-danger');
                    $(input).addClass('border border-success');
                }
        }
        
        function ValidarCurp(input,event){
            var valorCompleto = $(input).val() + event.key;               
            var RegEx = /^[a-zA-Z0-9]+$/;
            
                if(RegEx.test(valorCompleto)){
                    console.log("Se registro con exito");
                    $('#error'+input.id+'').text('');
                    $(input).removeClass('border border-danger');
                    $(input).addClass('border border-success');
                }else{
                    console.log("Error con el valor");
                    event.preventDefault();
                    $(input).addClass('border border-danger');
                    $('#error'+input.id+'').text('Sin caracteres especiales').css('color','red');
                };
        }
        
        function ValidarCurpBlur(input){
            var valorCompleto = $(input).val();               
            var RegEx = /^[a-zA-Z0-9]+$/;
            var RegEx2 = /^[a-zA-Z0-9]{18}$/;
            
                if(RegEx.test(valorCompleto)){
                    console.log("Se registro con exito");
                    $('#error'+input.id+'').text('');
                    $(input).removeClass('border border-danger');
                    $(input).addClass('border border-success');
                    if(RegEx2.test(valorCompleto)){
                         console.log("Se registro con exito");
                        $('#error'+input.id+'').text('');
                        $(input).removeClass('border border-danger');
                        $(input).addClass('border border-success');
                    }else{
                        console.log("Error con el valor");
                        event.preventDefault();
                        $(input).addClass('border border-danger');
                        $('#error'+input.id+'').text('Largo de la curp invalido').css('color','red');
                    }
                }
                
                //Podria agregarse validacion con las caracteristicas especiales de la curpa adema de la validacion de escritura
        }
        
        function ValidarFechaNacimiento(input,event){
            //var valorCompleto = $(input).val(); 
            var fechaIngresada = new Date($(input).val());
            var fechaActual = new Date();         
            var fechamenor18 = new Date;
            
            fechamenor18.setFullYear(fechamenor18.getFullYear()-18);
            
            if(fechaIngresada < fechaActual){
                
                if(fechaIngresada <fechamenor18){
                    $('#error'+input.id+'').text('');
                    $(input).removeClass('border border-danger');
                    $(input).addClass('border border-success');
                }else{
                    $(input).addClass('border border-danger');
                    $('#error'+input.id+'').text('No puede ser menor de edad').css('color','red');
                }
                
            }else{
                $(input).addClass('border border-danger');
                $('#error'+input.id+'').text('Fecha Invalida').css('color','red');
            }
            
        }
            
        ValidacionImagen = (event) =>{
            var imagen = document.getElementById('FotoUsuario');
            imagen.src = URL.createObjectURL(event.target.files[0]);
            const archivo = document.getElementById('imagenFile');
            
            if(archivo.files.length > 0){
                for(const i = 0; i< archivo.files.length -1;i++){
                    
                    const tamañoArchivo = archivo.files.item(i).size;
                    
                    const file = Math.random((tamañoArchivo/1024));
                    
                }
            }
        };
            
    </script>
</html>
